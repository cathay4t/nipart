# Title: ADR-003 Message Exchange

## Status: Accepted

## Context

Since `NipartEvent` is the only data exchanged between user/daemon/plugin,
we need a mechanism to:
 * Convert API request event to a set of plugin request event
 * Group plugin reply and generate reply to user
 * Handle concurrent API connection

## Decision

Introduce switch thread in daemon which has these connections:
 * The UUID is mandatory for each `NipartEvent`.
 * The events generated by daemon or plugin holds the UUID of original top
   level `NipartEvent`.
 * Upon plugin starts, switch will create single connection to plugin socket.
 * Daemon starts API thread tracking user request through `NipartEvent` UUID.
 * Each `NipartEvent` holds `src` and `dst` for switch decision.
 * Multicast to a group of plugins holding the same `NipartRole` is done via
   `NipartEventAddress::Group(NipartRole)`.
 * Switch thread is using IPC for plugin communication and use MPSC channels
   to communicate with API thread and daemon commander thread.

## Consequences

### Better

 * Daemon commander thread only maintain single communication channel to switch
   regardless the plugin counts.

 * Multicast support could save daemon commander thread from duplicating
   the request events.

### Worse

 * The MPSC channel will block on `send()` till it been `recv()`.
   The API thread and daemon commander thread should not be slow down on any
   task related to MPSC channel message processing.
