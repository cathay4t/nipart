# Title: ADR-002 Task Processing

## Status: Accepted

## Context

The network changing API requires multiple steps:
 1. Query related network state as current network state
 2. Validate desired network state with current network state
 3. Apply network state
 4. Verify whether post apply network state matches desired state.

The step 2 above require outcome of step 1.
The step 3 requires outcomes of steps 1 and 2.
The step 4 need similar task like step 1 to query related state.

We need both grouping steps for sharing data and splitting them for code
isolation.

## Decision

Introduced `Event`, `Task` and `Workflow`:

 * `Event` is only communication data exchanging between user/daemon/plugin.
 * `Event` for API request or network change event generated by plugins(e.g.
   link up down)
 * `Event` been converted into `Workflow` by daemon commander.
 * `Workflow` contains multiple `Task`.
 * `Workflow` holds share data between tasks.
 * `Task` holds generate request and replies it got.
 * Upon finish of each task, a call back function maybe invoked
   with mutable access to share data.
 * Different call function can be applied to the same kind of task.
   For example, above step 1 and step 4 both need to query related network
   state for desired, but their outcome should be stored differently as
   `pre_apply_net_state` vs `post_apply_net_state` in shared data.

Alternative design would chaining event process functions meaning finishing of
previous task is required to make decision on next task.
Without grouping and context, this event process chain design will complex
runtime debugging due to the missing of big picture.

## Consequences

### Better

 * Easy to share code between similar tasks

 * Developer could provide full task list in single place upon the API/Plugin
   event been processed.

### Worse

 * The `WorkFlowShareData` structure will hold all optional shareable data
   which might be 99% not useful for some workflow. For example query plugin
   information workflow does not require any share data, but still it
   initialized a full None share data. No better design yet.
